---
title: "Scoring the SF-36"
author: "Dom Grisafe"
date: "12/11/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#R packages
library(readxl)
library(dplyr)
library(stringr)
library(tidyverse)
library(xlsx)
```

#SF-36
The [SF-36](https://www.rand.org/health/surveys_tools/mos/36-item-short-form/survey-instrument.html), produced by RAND, is one of the most common instruments for measuring quality of life. It is frustrating to learn to manually score the SF-36, when it is clear that numerous researchers must be recoding the survey each time. This is my attempt to automate the administration and scoring of the SF-36.

##Google Form Version of SF-36
Here is a [folder](https://drive.google.com/drive/folders/1W7OvdZls7Y52vpiyQKPgF1YVjpXtSNPd?usp=sharing) containing the Google Form version of the SF-36 as well as the corresponding Google Sheet containing dummy responses. Google does not allow public sharing of a Form, and this will unfortunately have to be recreated by others manually.

Google forms eliminate data entry steps, make the data collection process more repeatable, and can save money on unnecessary administrative costs. Google forms are not commonly used in academia despite [commentaries encouraging the use of Google Forms in health and social sciences](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3884902/).

##Loading the SF-36 from Google Form to Excel to R
Once data has been collected using the Google Form, download the file as an excel document. This can then be loaded into R using the [readxl](https://www.rdocumentation.org/packages/readxl/versions/0.1.1) package. This is dummy data made for the purposes of explanation, which was placed in the same folder as the R Markdown file.
```{r echo = TRUE}
#import from excel to R using readxl
data <- read_excel("36 Item Short Form Survey Instrument (SF-36) (Responses).xlsx")

#save a record of the original data for reference
data_orig <- data

#look at item variables and number of observations
glimpse(data)
```

##Recoding the SF-36
RAND provides [Scoring Instructions](https://www.rand.org/health/surveys_tools/mos/36-item-short-form/scoring.html). Ron Hays has published a [SAS program](https://www.rand.org/pubs/drafts/DRU1437.html) to score the SF-36 automatically; this [Word version](https://cours.etsmtl.ca/gts813/documents/sf36_scoring_system.doc) was used as a template for scoring the survey in R. All variables should be renamed and certain items must be reversed.
```{r recode}
#rename the columns
cols <- c("timestamp", "ptid", "intid", paste0("I", 1:36))
colnames(data) <- cols
#save dataset with I1:I36 variables as strings
data_str <- data

#recode answers to numerics
##get the first character digit in each string (the number score value)
data_1str <- sapply(X = data[,4:39], FUN = substr, start = 1, stop = 1)

##make new data frame where SF-36 scores are numeric (not factor)
data <- cbind(data_str[,1:3], data.frame(data_1str, stringsAsFactors = TRUE))
data <- as.data.frame(lapply(data, function(x) {
    if(is.factor(x)) as.numeric(as.character(x)) else x
}))

##convert data to tible
data <- tbl_df(data)

# sort by ptid
data <- data %>% arrange(ptid)

#data_1num <- mutate_all(.tbl = data_1str, .vars = 4:39, function(x) as.numeric())

#score from Ron Hays instructions
#*****************************************************************; 

##Assign arrays for recoding each item in approptiate direction and converting to 0 to 100 scale
IDINFO  <- select(data, timestamp, ptid, intid)
RFIVEPT <- select(data, ptid,  I1,  I2, I20, I22, I34,  I36)
THREEPT <- select(data, ptid,  I3,  I4,  I5,  I6,  I7,   I8,  I9, I10, I11, I12)
TWOPT   <- select(data, ptid, I13, I14, I15, I16, I17,  I18, I19)
RSIXPT  <- select(data, ptid, I21, I23, I26, I27, I30)
SIXPT   <- select(data, ptid, I24, I25, I28, I29, I31)
FIVEPT  <- select(data, ptid, I32, I33, I35)

#*****************************************************************;

##sf items (recoded in next section below)
I1SF  <- select(data, ptid, I1)
I21SF <- select(data, ptid, I21)
I22SF <- select(data, ptid, I22)

##recode, reverse 5-point items to 0-100 scale
RFIVEPT[,2:7] <- sapply(X = RFIVEPT[,2:7], FUN = function(x) {
  x[x == 1] <- 100
  x[x == 2] <- 75
  x[x == 3] <- 50
  x[x == 4] <- 25
  x[x == 5] <- 0
  x
  })

##recode 3-point items to 0-100 scale
THREEPT[,2:11] <- sapply(X = THREEPT[,2:11], FUN = function(x) {
  x[x == 1] <- 0
  x[x == 2] <- 50
  x[x == 3] <- 100
  x
  })

##recode 2-point items to 0-100 scale
TWOPT[,2:8] <- sapply(X = TWOPT[,2:8], FUN = function(x) {
  x[x == 1] <- 0
  x[x == 2] <- 100
  x
  })

##recode, reverse 6-point items to 0-100 scale
RSIXPT[,2:6] <- sapply(X = RSIXPT[,2:6], FUN = function(x) {
  x[x == 1] <- 100
  x[x == 2] <- 80
  x[x == 3] <- 60
  x[x == 4] <- 40
  x[x == 5] <- 20
  x[x == 6] <- 0
  x
  })

##recode 6-point items to 0-100 scale
SIXPT[,2:6] <- sapply(X = SIXPT[,2:6], FUN = function(x) {
  x[x == 1] <- 0
  x[x == 2] <- 20
  x[x == 3] <- 40
  x[x == 4] <- 60
  x[x == 5] <- 80
  x[x == 6] <- 100
  x
  })

##recode 5-point items to 0-100 scale
FIVEPT[,2:4] <- sapply(X = FIVEPT[,2:4], FUN = function(x) {
  x[x == 1] <- 0
  x[x == 2] <- 25
  x[x == 3] <- 50
  x[x == 4] <- 75
  x[x == 5] <- 100
  x
  })

#*****************************************************************;

##recode sf items to 0-100 scale

##original SF item scores
before <- I1SF %>%
  inner_join(I21SF, by = "ptid") %>%
  inner_join(I22SF, by = "ptid")

###recode item 1 to 0-100 scale

####initialize new column for scaled values
I1SF$I1SF <- NA

####recode scores
I1SF$I1SF[I1SF$I1 == 1] <- 5.0
I1SF$I1SF[I1SF$I1 == 2] <- 4.4
I1SF$I1SF[I1SF$I1 == 3] <- 3.4
I1SF$I1SF[I1SF$I1 == 4] <- 2.0
I1SF$I1SF[I1SF$I1 == 5] <- 1.0

#scale
I1SF$I1SF <- (I1SF$I1SF - 1) * 25


###recode item 22 to 0-100 scale, depending on value of item 21

#####note: use single ampersand so each row is tested (vectorized), not just the first element

for (row in 1:nrow(before)) {
  
  if (!is.na(before$I21[row]) && !is.na(before$I22[row])) {
    #####if no missing values for item 21 and 22, item 22 has 6 levels for 0-100 score
    
    I22SF$I22[before$I22 == 1 &  before$I21 == 1] <- 6
    I22SF$I22[before$I22 == 1 & (before$I21 > 1 & before$I21 < 7)] <- 5
    I22SF$I22[before$I22 == 2 & (before$I21 > 0 & before$I21 < 7)] <- 4
    I22SF$I22[before$I22 == 3 & (before$I21 > 0 & before$I21 < 7)] <- 3
    I22SF$I22[before$I22 == 4 & (before$I21 > 0 & before$I21 < 7)] <- 2
    I22SF$I22[before$I22 == 5 & (before$I21 > 0 & before$I21 < 7)] <- 1
    
  } else if (is.na(before$I21[row]) && !is.na(before$I22[row])) {
    #####if missing values for item 21, but not item 22, item 22 has 5 levels for 0-100 score
    
    I22SF$I22[before$I22 == 1] <- 6.0
    I22SF$I22[before$I22 == 2] <- 4.75
    I22SF$I22[before$I22 == 3] <- 3.5
    I22SF$I22[before$I22 == 4] <- 2.25
    I22SF$I22[before$I22 == 5] <- 1.0
    
  }
}

#scale
I22SF$I22SF <- (I22SF$I22 - 1) * 20


###recode item 21 to 0-100 scale
I21SF$I21[before$I21 == 1] <- 6.0
I21SF$I21[before$I21 == 2] <- 5.4
I21SF$I21[before$I21 == 3] <- 4.2
I21SF$I21[before$I21 == 4] <- 3.1
I21SF$I21[before$I21 == 5] <- 2.2
I21SF$I21[before$I21 == 6] <- 1.0

#scale
I21SF$I21SF <- (I21SF$I21 - 1) * 20

#drop unscaled scores
I1SF$I1   <- NULL
I22SF$I22 <- NULL
I21SF$I21 <- NULL


#get 8 scales, physical and mental subscales
#*****************************************************************;
  
#put all the scaled items together
data0100 <- IDINFO %>%
  inner_join(RFIVEPT, by = "ptid") %>% 
  inner_join(THREEPT, by = "ptid") %>% 
  inner_join(TWOPT,   by = "ptid") %>% 
  inner_join(RSIXPT,  by = "ptid") %>% 
  inner_join(SIXPT,   by = "ptid") %>% 
  inner_join(FIVEPT,  by = "ptid") %>% 
  inner_join(I1SF,    by = "ptid") %>% 
  inner_join(I21SF,   by = "ptid") %>% 
  inner_join(I22SF,   by = "ptid") 

#calculate scales by taking means of select 0-100 scaled items
# 8 SF-36 scale scores

  ## Physical Health
      # Physical functioning, 10 items:	3 4 5 6 7 8 9 10 11 12
      # Role limitations due to physical health,	4 items:	13 14 15 16
      # Pain,	2 items:	21 22
      # General health,	5 items:	1 33 34 35 36

  ## Mental Health
      # Energy/fatigue/vitality,	4 items:	23 27 29 31
      # Social functioning,	2	items: 20 32
      # Role limitations due to emotional problems,	3 items:	17 18 19
      # Emotional well-being,	5	items: 24 25 26 28 30

# SF-36 physical and mental health composite scores
data0100 <- mutate(data0100, 
                   
  ##Physical Composite Scale
                   
      # Physical functioning, 10 items:	3 4 5 6 7 8 9 10 11 12
       PHYFUN10 = rowMeans(select(data0100,I3,I4,I5,I6,I7,I8,I9,I10,I11,I12),na.rm = TRUE),
      
      # Role limitations due to physical health,	4 items:	13 14 15 16
       ROLEP4 = rowMeans(select(data0100,I13,I14,I15,I16),na.rm = TRUE),
      
      # Pain,	2 items:	21 22
       PAIN2 = rowMeans(select(data0100,I21,I22),na.rm = TRUE),
       SFPAIN = rowMeans(select(data0100,I21SF,I22SF),na.rm = TRUE),
      
      # General health,	5 items:	1 33 34 35 36
       GENH5 = rowMeans(select(data0100,I1,I33,I34,I35,I36),na.rm = TRUE),
       SFGENH5 = rowMeans(select(data0100,I1SF,I33,I34,I35,I36),na.rm = TRUE),

  ##Mental Composite Scale
  
      # Energy/fatigue,	4 items:	23 27 29 31
       ENFAT4 = rowMeans(select(data0100,I23,I27,I29,I31),na.rm = TRUE),
      
      # Social functioning,	2	items: 20 32
       SOCFUN2 = rowMeans(select(data0100,I20,I32),na.rm = TRUE),
  
       # Role limitations due to emotional problems,	3 items:	17 18 19
       ROLEE3 = rowMeans(select(data0100,I17,I18,I19),na.rm = TRUE),

       # Emotional well-being,	5	items: 24 25 26 28 30
       EMOT5 = rowMeans(select(data0100,I24,I25,I26,I28,I30),na.rm = TRUE)
)
```

##Calculating Standardized Component Scores: Physical and Mental Composites
The [Australian Longitudinal Study on Women's Health](https://www.alswh.org.au/) provides [instructions on how to calculate the physical and mental composite scores](http://www.alswh.org.au/images/content/pdf/InfoData/Data_Dictionary_Supplement/DDSSection2SF36.pdf) of the SF-36 when all of the 8 subscales are available.
```{r}
# make vectors of scale names and abbreviations
SF36_scales <- c("Physical Functioning", "Role Physical", "Bodily Pain", "General Health", "Vitality", "Social Functioning", "Role Emotional", "Mental Health")
SF36_abbrev <- c("PF", "RP", "BP", "GH", "VT", "SF", "RE", "MH")

#select 8 SF-36 subscale scores
subScale8 <- select(data0100, ptid,
                    PHYFUN10,ROLEP4,PAIN2,GENH5,
                    ENFAT4,SOCFUN2,ROLEE3,EMOT5)
sumScale8 <- summarize(subScale8, 
          meanPF = mean(PHYFUN10), sdPF = sd(PHYFUN10),
          meanRP = mean(ROLEP4), sdRP = sd(ROLEP4),
          meanBP = mean(PAIN2), sdBP = sd(PAIN2),
          meanGH = mean(GENH5), sdGH = sd(GENH5),
          meanVT = mean(ENFAT4), sdVT = sd(ENFAT4),
          meanSF = mean(SOCFUN2), sdSF = sd(SOCFUN2),
          meanRE = mean(ROLEE3), sdRE = sd(ROLEE3),
          meanMH = mean(EMOT5), sdMH = sd(EMOT5)
          )

# set subscale column names to abbreviations
colnames(subScale8) <- c("ptid", SF36_abbrev)

# make this into a tibble of each subscale (rows) by statistics mean and sd. Figure out naming
finalTable <- as.numeric(sumScale8[1,]) %>% 
  matrix(ncol = 2, nrow = 8, byrow = T) %>% 
  as_tibble()

# add scale names
finalTable <- finalTable %>% 
  add_column(SF36_scales)

# add scale abbreviations
finalTable <- finalTable %>% 
  add_column(SF36_abbrev)

# name columns and reorder columns
colnames(finalTable) <- c("mean", "stdDev", "Scale", "Abbreviation")

# formatted final table
finalTable <- finalTable %>% select(Scale, Abbreviation, mean, stdDev)
```


##Comparing SF-36 Scores of Sample to US
Use [scale scores standardized from the general US population](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3582698/) to calculate Physical Composite Score (PCS) and Mental Composite Score (MCS). An excel file will be produced enumerating the 8 scale scores as well as the PCS and MCS.
```{r compScore}
# import standard US general population scores of the SF-36
 SF36_GenPopUS <- read_excel("SF36_GenPopUS.xlsx", sheet = 1)


## This produces an average PCS and MCS for the entire sample, but we need to calculate for each individual first
  
  # select only the 8 subscales from the Gen US Population SF-36 data
  SF36_8Scales <- SF36_GenPopUS %>% slice(1:8)
  
  # calculate standardized scores of the 8 scales for the sample
  finalCSTable <- finalTable %>% 
    mutate(stdScale = (mean - SF36_8Scales$Mean)/SF36_8Scales$SD)
  
  # calculate the PCS and MCS
  PCS <- finalCSTable %>% slice(1:4) %>% summarize(sum(stdScale) * 10 + 50) %>% as.numeric()
  MCS <- finalCSTable %>% slice(5:8) %>% summarize(sum(stdScale) * 10 + 50) %>% as.numeric()
  
  
## Calculate PCS and MCS for each individual

  # calculate standardized scores for each participant
  std_subScale8 <- subScale8 %>% 
    mutate(
      stdPF = (PF - as.numeric(SF36_GenPopUS[1,3])) / as.numeric(SF36_GenPopUS[1,5]),
      stdRP = (RP - as.numeric(SF36_GenPopUS[2,3])) / as.numeric(SF36_GenPopUS[2,5]),
      stdBP = (BP - as.numeric(SF36_GenPopUS[3,3])) / as.numeric(SF36_GenPopUS[3,5]),
      stdGH = (GH - as.numeric(SF36_GenPopUS[4,3])) / as.numeric(SF36_GenPopUS[4,5]),
      stdVT = (VT - as.numeric(SF36_GenPopUS[5,3])) / as.numeric(SF36_GenPopUS[5,5]),
      stdSF = (SF - as.numeric(SF36_GenPopUS[6,3])) / as.numeric(SF36_GenPopUS[6,5]),
      stdRE = (RE - as.numeric(SF36_GenPopUS[7,3])) / as.numeric(SF36_GenPopUS[7,5]),
      stdMH = (MH - as.numeric(SF36_GenPopUS[8,3])) / as.numeric(SF36_GenPopUS[8,5])
      )

  # calculate PCS and MCS for each participant
  std_subScale8 <- std_subScale8 %>% 
    mutate(
      PCS = (stdPF + stdRP + stdBP + stdGH) * 10 + 50,
      MCS = (stdVT + stdSF + stdRE + stdMH) * 10 + 50
    )
  
  
# calculate PCS and MCS averages for all participants
  tableCS <- std_subScale8 %>% summarize(
    meanPCS = mean(PCS), sdPCS = sd(PCS),
    meanMCS = mean(MCS), sdMCS = sd(MCS)
  )
  tableCS <- as.numeric(tableCS[1,]) %>% 
  matrix(ncol = 2, nrow = 2, byrow = T) %>% 
  as_tibble()
  # add labels and abbreviations
  tableCS <- tableCS %>% 
    add_column(c("Physical Composite Score", "Mental Composite Score"))
  tableCS <- tableCS %>% 
    add_column(c("PCS", "MCS"))
  colnames(tableCS) <- c("mean", "stdDev", "Scale", "Abbreviation")
  tableCS <- tableCS %>% select(Scale, Abbreviation, mean, stdDev)


# add PCS and MCS to finalTable
  finalComposite <- rbind(finalTable, tableCS)

  
# set precision on mean and standard deviation columns
  finalComposite <- finalComposite %>% 
    mutate(
      mean = round(mean, digits = 1),
      stdDev = round(stdDev, digits = 1)
    )
  
# export to excel
  write.xlsx(finalComposite, "!SF36_CompositeScores.xlsx")
```


#References
[SF-36](https://www.rand.org/health/surveys_tools/mos/36-item-short-form/survey-instrument.html) by RAND  
[Google Drive Folder](https://drive.google.com/drive/folders/1W7OvdZls7Y52vpiyQKPgF1YVjpXtSNPd?usp=sharing) containing SF-36 Form and Sheet Output  
[Commentaries encouraging the use of Google Forms in health and social sciences](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3884902/)  
[readxl](https://www.rdocumentation.org/packages/readxl/versions/0.1.1) package  
SF-36 [Scoring Instructions](https://www.rand.org/health/surveys_tools/mos/36-item-short-form/scoring.html) by RAND  
SF-36 Scoring Program in [SAS](https://www.rand.org/pubs/drafts/DRU1437.html) by Ron Hayes  
SF-36 Scoring Program in [Word](https://cours.etsmtl.ca/gts813/documents/sf36_scoring_system.doc)  
[Australian Longitudinal Study on Women's Health](https://www.alswh.org.au/)  
[Calculating physical and mental composite scores of SF-36](http://www.alswh.org.au/images/content/pdf/InfoData/Data_Dictionary_Supplement/DDSSection2SF36.pdf)  
[Standardize SF-36 scores to the general US population](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3582698/)  